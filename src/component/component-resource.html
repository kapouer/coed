<!DOCTYPE html>
<html>
<head>
<title>Component Resource Custom Element</title>
<script src="agent.js"></script>
<script src="domt.js"></script>
<link href="component-font.css" rel="stylesheet" />
<link href="component-style.css" rel="stylesheet" />

<script type="text/template" id="component-widget-begin">
	<a class="type" bind-href="attr.href">
		<i bind-class="icon-[attr.type|icon]"></i><br>
		<img class="favicon" bind-src="attr.icon|hide">
	</a>
</script>
<script type="text/template" id="component-widget-end">
	<div class="thumbnail">
		<img bind-src="attr.thumbnail|hide" />
	</div>
	<div class="text">380x240</div>
</div>
</script>

<script>(function() {

var ownDoc = (document._currentScript ||Â document.currentScript).ownerDocument;
var widgetTemplates = {
	begin: Domt.template(ownDoc.getElementById('component-widget-begin')),
	end: Domt.template(ownDoc.getElementById('component-widget-end'))
};

var widgetProto = Object.create(HTMLElement.prototype);
var resourceProto = Object.create(HTMLElement.prototype);

function merge(me, attrs) {
	Domt(me).merge({
		attr: attrs
	}, {
		hide: function(val, context) {
			if (!val) context.node.setAttribute("hidden", "");
			else context.node.removeAttribute("hidden");
			return val;
		},
		icon: function iconFilter(val) {
			if (!val || val == "none") return "spin";
			return val;
		},
		href: function(val, context) {
			if (!val) val = context.scope.attr.href;
			return val;
		}
	});
}

widgetProto.attachedCallback = function() {
	var me = this;
	if (!me.childNodes.length) {
		var type = this.getAttribute('type');
		me.appendChild(widgetTemplates[type].clone().merge().import());
	}
	if (this.parentNode) this.parentNode.attributeChangedCallback();
};


document.registerElement('component-widget', {
	prototype: widgetProto
});

resourceProto.props = function(obj) {
	var me = this;
	var atts = me.attributes;
	var att, i;
	if (obj) {
		for (i = 0; i < atts.length; i++) {
			me.removeAttributeNode(atts[i]);
		}
		Object.keys(obj).forEach(function(name) {
			me.setAttribute(name, obj[name]);
		});
	} else {
		obj = {};
		for (i = 0; i < atts.length; i++) {
			att = atts[i];
			obj[att.name] = att.value;
		}
	}
	return obj;
};

resourceProto.attachedCallback = function() {
	var me = this;
	var attrs = me.props();
	if (!attrs.title) attrs.title = attrs.href;
	if (!attrs.description) attrs.description = null;

	merge(this, attrs);
};

resourceProto.attributeChangedCallback = function(name) {
	merge(this, this.props());
};

document.registerElement('component-resource', {
	prototype: resourceProto
});

})();</script>
</head>
</html>
