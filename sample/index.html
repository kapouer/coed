<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Sample editor</title>
	<link rel="stylesheet" href="../dist/pagecut.css" />
	<link rel="stylesheet" href="../dist/pagecut-menu.css" />
	<link rel="stylesheet" href="inspector.css" />
	<link rel="stylesheet" href="index.css" />

	<script src="../dist/pagecut-editor.js"></script>
	<script src="../dist/pagecut-menu.js"></script>
	<script src="../dist/pagecut-id.js"></script>

	<script src="agent.js"></script>
	<script src="diffDOM.js"></script>
	<script src="dom-template-strings.js"></script>
	<script src="inspector.js"></script>

	<script>
document.addEventListener('DOMContentLoaded', function() {
	var differ = new window.diffDOM({
		filterOuterDiff: function(from, to, diffs) {
			// do not diff inside a rendered co-link, attributes will change anyway
			if (from.nodeName == "DIV" && from.attributes && from.attributes['data-type'] && !diffs.length) {
				from.innerDone = true;
			}
		}
	});
	var contentNode = document.getElementById("content");

	function DifferRender(id) {
		this.id = id;
	}

	DifferRender.prototype.update = function(view) {
		var from = document.getElementById(this.id);
		var to = document.createElement('div');
		to.id = this.id;
		to.appendChild(view.get());
		differ.apply(from, differ.diff(from, to));
	};

	// expose pagecut instance for debug purpose only
	Pagecut.sample = new Pagecut.Editor({
		place: "#editor",
		plugins: [
			new DifferRender('preview'),
			function(editor, opts) {
				var items = Pagecut.Setup.buildMenuItems(editor.schema);
				var menubar = new Pagecut.Menubar({
					place: document.querySelector('#menubar'),
					items: [
						[items.toggleStrong, items.toggleEm, items.toggleCode],
						[items.wrapBulletList, items.wrapOrderedList, items.wrapBlockQuote],
						[Pagecut.Menubar.Menu.undoItem, Pagecut.Menubar.Menu.redoItem],
					]
				});
				return menubar;
			}
		]
		// content: contentNode // we need to seed inspector module before
	});

	Pagecut.test = function() {
		var id = Pagecut.sample.modules.id;
		var fragmentBlock = id.to();
		var storedBlocks = id.store;
		console.log("Document exported as", fragmentBlock, storedBlocks);
		id.store = storedBlocks;
		id.from(fragmentBlock).then(function(fragment) {
			console.log("Exported document rendered as", fragment);
		}).catch(function(err) {
			console.error(err);
		});

		// example with a really async resolver
		id.from(fragmentBlock, function(id) {
			return new Promise(function(resolve) {
				setTimeout(function() {
					resolve(storedBlocks[id]);
				}, 100);
			});
		}).then(function(fragment) {
			console.log("Exported document asynchronously rendered as", fragment);
		}).catch(function(err) {
			console.error(err);
		});
	};

	Pagecut.sample.modules.inspector.set([{
		id: 1,
		type: 'inspector',
		url: "https://fr.wikipedia.org/wiki/GIE_SESAM-Vitale",
		data: {
			mime: 'text/html; charset=UTF-8',
			type: 'link',
			title: 'SESAM-Vitale — Wikipédia',
			icon: 'https://fr.wikipedia.org/static/favicon/wikipedia.ico',
			size: 140064,
			site: 'fr.wikipedia.org override',
			ext: 'html',
			html: '<a href="https://fr.wikipedia.org/wiki/GIE_SESAM-Vitale">SESAM-Vitale — Wikipédia</a>'
		},
		content: {
			title: '<span>overriden title</span>',
			content: '<p>Toto la praline</p><div block-type="inspector" block-url="https://pixabay.com/static/uploads/photo/2016/07/29/09/37/cat-1551783__340.jpg"></div>'
		}
	}, {
		id: 2,
		type: "inspector",
		url: "https://pixabay.com/static/uploads/photo/2016/07/29/09/37/cat-1551783__340.jpg",
		data: {
			mime: 'image/jpeg',
			type: 'image',
			thumbnail: 'https://pixabay.com/static/uploads/photo/2016/07/29/09/37/cat-1551783__340.jpg',
			size: 38173,
			title: 'cat-1551783__340.jpg',
			ext: 'jpg',
			width: 513,
			height: 340,
			site: 'pixabay.com',
			html: '<img src="https://pixabay.com/static/uploads/photo/2016/07/29/09/37/cat-1551783__340.jpg" alt="cat-1551783__340.jpg" />',
			icon: 'https://pixabay.com/favicon-32x32.png'
		}
	}]);

	Pagecut.sample.modules.inspector.inspect = function(url, cb) {
		GET("https://inspector.eda.sarl/inspector", {url: url}, cb);
	};
	Pagecut.sample.set(contentNode);
	contentNode.hidden = true;
});
	</script>
</head>
<body>

Pagecut demo.
<br />

<div id="menubar" class="ProseMirror-menu"></div>
<div id="editor"></div>

<div id="content">
<p>a</p>
<div block-type="inspector" block-url="https://fr.wikipedia.org/wiki/GIE_SESAM-Vitale">
	<header>
		<a name="type"></a>
		<a title="fr.wikipedia.org" target="_blank" href="https://fr.wikipedia.org/wiki/GIE_SESAM-Vitale"><img src="https://fr.wikipedia.org/static/favicon/wikipedia.ico" />
		</a>
		<a name="preview"></a>
	</header>
	<div block-ancestor>
		<div block-content="title"><span>SESdAM-Vitale — Wikipédia</span></div>
		<div block-content="content"><p><span>Ceci est un lien qui contient une image</span></p>
			<div class="inspector" block-url="https://pixabay.com/static/uploads/photo/2016/07/29/09/37/cat-1551783__340.jpg" type="image" block-type="inspector" block-id="2">
	<header block-handle="">
		<a name="type"></a>
		<a title="pixabay.com" target="_blank"><img src="https://pixabay.com/favicon-32x32.png" /></a>
		<a name="preview"></a>
	</header>
	<div block-ancestor>
		<div block-content="title"></div>
		<div block-content="content"></div>
	</div>
	<aside>
		<div>
			<div><span title="dimensions">513x340</span><span title="duration"></span><span title="size">38KB</span></div>
			<p></p>
		</div>
		<figure><img src="https://pixabay.com/static/uploads/photo/2016/07/29/09/37/cat-1551783__340.jpg" /></figure>
	</aside>
</div>
			<p><span>et avec du texte en dessous aussi</span></p>
		</div>
	</div>
	<aside>
		<div>
			<div>
				<span title="dimensions"></span>
				<span title="duration"></span>
				<span title="size"></span>
			</div>
			<p></p>
		</div>
		<figure></figure>
	</aside>
</div>
<p>hahaha</p>
</div>

<div id="preview"></div>
</body>
</html>
