<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Sample editor</title>
	<link href="../dist/pagecut.css" rel="stylesheet" />
	<link href="../dist/inspector.css" rel="stylesheet" />
	<script src="../dist/pagecut-editor.js"></script>
	<script src="../dist/inspector.js"></script>
	<script src="../dist/id.js"></script>
	<script src="agent.js"></script>
	<script src="diffDOM.js"></script>
	<style>
html {
	height:100%;
}
body {
	display:flex;
	flex-direction:column;
	height:100%;
	margin:0;
}
#editor {
	flex: 1 1 auto;
	margin:1em;
	border:1px solid silver;
}
.ProseMirror-content {
	margin:0.1em;
	padding:0.1em;
}
#preview {
	flex: 1 1 auto;
	margin:1em;
	border:2px solid black;
	overflow:auto;
	max-height:100%;
}
	</style>
	<script>
document.addEventListener('DOMContentLoaded', function() {
	if (window.GET && diffDOM) {
		document.getElementById('install').remove();
	}
	if (/github\.io/.test(document.location.hostname)) {
		document.body.insertAdjacentHTML('afterbegin', '<iframe src="https://ghbtns.com/github-btn.html?user=kapouer&repo=pagecut&type=star" frameborder="0" scrolling="0" width="170px" height="20px"></iframe>');
	}

	var differ = new diffDOM({
		filterOuterDiff: function(from, to, diffs) {
			// do not diff inside a rendered co-link, attributes will change anyway
			if (from.nodeName == "DIV" && from.attributes && from.attributes['data-type'] && !diffs.length) {
				from.innerDone = true;
			}
		}
	});
	var contentNode = document.getElementById("content");

	// expose pagecut instance for debug purpose only
	Pagecut.sample = new Pagecut.Editor({
		menu: function(me, items) {
			return [
				[items.toggleStrong, items.toggleEm, items.toggleCode],
				[items.wrapBulletList, items.wrapOrderedList, items.wrapBlockQuote],
				[me.Menu.undoItem, me.Menu.redoItem],
			];
		},
		place: "#editor",
		update: function(me, transaction) {
			if (!transaction.docChanged) return;
			setTimeout(function() {
				var from = document.getElementById('preview');
				var to = document.createElement('div');
				to.id = 'preview';
				to.appendChild(me.get());
				differ.apply(from, differ.diff(from, to));
			});
		},
		change: function(me, block) {
			// TODO
			// 1) the document should be considered a block here, so root changes are received
			// 2) update the online blocks store (which has DOM Nodes inside content, not html)
			// 3) optimization: update preview by block

			// console.log(block);
		},
		// content: contentNode // we need to seed inspector module before
	});

	Pagecut.test = function() {
		var id = Pagecut.sample.modules.id;
		var storedBlocks = {};
		var fragmentBlock = id.to(storedBlocks);
		console.log("Document exported as", fragmentBlock, storedBlocks);
		id.from(fragmentBlock, storedBlocks).then(function(fragment) {
			console.log("Exported document rendered as", fragment);
		}).catch(function(err) {
			console.error(err);
		});

		// example with a really async resolver
		id.from(fragmentBlock, {}, function(id) {
			return new Promise(function(resolve) {
				setTimeout(function() {
					resolve(storedBlocks[id]);
				}, 100);
			});
		}).then(function(fragment) {
			console.log("Exported document asynchronously rendered as", fragment);
		}).catch(function(err) {
			console.error(err);
		});
	};
	Pagecut.sample.modules.inspector.set([{
		id: 1,
		type: 'link',
		url: "https://fr.wikipedia.org/wiki/GIE_SESAM-Vitale",
		data: {
			mime: 'text/html; charset=UTF-8',
			type: 'link',
			title: 'SESAM-Vitale — Wikipédia',
			icon: 'https://fr.wikipedia.org/static/favicon/wikipedia.ico',
			size: 140064,
			site: 'fr.wikipedia.org override',
			ext: 'html',
			html: '<a href="https://fr.wikipedia.org/wiki/GIE_SESAM-Vitale">SESAM-Vitale — Wikipédia</a>'
		},
		content: {
			title: '<span>overriden title</span>',
			content: '<p>Toto la praline</p><div block-type="link" block-url="https://pixabay.com/static/uploads/photo/2016/07/29/09/37/cat-1551783__340.jpg"></div>'
		}
	}, {
		id: 2,
		type: "link",
		url: "https://pixabay.com/static/uploads/photo/2016/07/29/09/37/cat-1551783__340.jpg",
		data: {
			mime: 'image/jpeg',
			type: 'image',
			thumbnail: 'https://pixabay.com/static/uploads/photo/2016/07/29/09/37/cat-1551783__340.jpg',
			size: 38173,
			title: 'cat-1551783__340.jpg',
			ext: 'jpg',
			width: 513,
			height: 340,
			site: 'pixabay.com',
			html: '<img src="https://pixabay.com/static/uploads/photo/2016/07/29/09/37/cat-1551783__340.jpg" alt="cat-1551783__340.jpg" />',
			icon: 'https://pixabay.com/favicon-32x32.png'
		}
	}]);

	Pagecut.sample.modules.inspector.inspect = function(url, cb) {
		GET("https://inspector.eda.sarl/inspector", {url: url}, cb);
	};
	Pagecut.sample.set(contentNode);
	contentNode.hidden = true;


});
	</script>
</head>
<body>

Pagecut demo.
<br>
<code id="install">npm install window-agent diff-dom</code>

<div id="editor"></div>

<div id="content">
<p>a</p>
<div block-type="link" block-url="https://fr.wikipedia.org/wiki/GIE_SESAM-Vitale">
	<header>
		<a name="type"></a>
		<a title="fr.wikipedia.org" target="_blank" href="https://fr.wikipedia.org/wiki/GIE_SESAM-Vitale"><img src="https://fr.wikipedia.org/static/favicon/wikipedia.ico"></a>
		<a name="preview"></a>
	</header>
	<div>
		<div block-content="title"><span>SESdAM-Vitale — Wikipédia</span></div>
		<div block-content="content"><p><span>Ceci est un lien qui contient une image</span></p>
			<div block-type="link" block-url="https://pixabay.com/static/uploads/photo/2016/07/29/09/37/cat-1551783__340.jpg"></div>
			<p><span>et avec du texte en dessous aussi</span></p>
		</div>
	</div>
	<aside>
		<div>
			<div>
				<span title="dimensions"></span>
				<span title="duration"></span>
				<span title="size"></span>
			</div>
			<p></p>
		</div>
		<figure></figure>
	</aside>
	<script type="text/html"><a href="https://fr.wikipedia.org/wiki/GIE_SESAM-Vitale">SESAM-Vitale — Wikipédia</a></script>
</div>
<p>hahaha</p>
</div>

<div id="preview"></div>
</body>
</html>
